<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de WOs</title>
    <!-- CSS Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- CSS Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; }
        #map { height:100vh; width:100%; }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 350px;
            height: 100vh;
            background: white;
            z-index: 1000;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .form-section { margin-bottom: 20px; }
        .wo-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #eee; }
        .wo-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4>Adicionar WO</h4>
        <form id="woForm">
            <div class="mb-3">
                <label>Número WO*</label>
                <input type="text" class="form-control" id="woNumber" required>
            </div>
            <div class="mb-3">
                <label>PDO*</label>
                <input type="text" class="form-control" id="pdo" required>
            </div>
            <div class="mb-3">
                <label>Coordenadas* (lat,lng)</label>
                <input type="text" class="form-control" id="coordinates" placeholder="38.704803,-9.400177" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Salvar</button>
        </form>

        <h4 class="mt-4">Filtrar</h4>
        <form id="filterForm">
            <div class="mb-3">
                <label>Status</label>
                <select class="form-select" id="filterStatus">
                    <option value="">Todos</option>
                    <option value="aberta">Aberta</option>
                    <option value="pendente">Pendente</option>
                    <option value="fechada">Fechada</option>
                </select>
            </div>
            <button type="submit" class="btn btn-secondary w-100 mb-2">Filtrar</button>
            <button type="button" id="exportBtn" class="btn btn-success w-100">Exportar CSV</button>
        </form>

        <h4 class="mt-4">Lista de WOs</h4>
        <div id="woList"></div>
    </div>

    <div id="map"></div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase 9 (versão modular) -->
    <script type="module">
        // Importação correta do Firebase v9
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDEiw_eRnSF782y5WICI8NBPox2203Qu-0",
            authDomain: "mapa-23b48.firebaseapp.com",
            databaseURL: "https://mapa-23b48-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "mapa-23b48",
            storageBucket: "mapa-23b48.firebasestorage.app",
            messagingSenderId: "468462304112",
            appId: "1:468462304112:web:d4221e35917be991336db5",
            measurementId: "G-R97REGBXMZ"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const woRef = ref(db, 'workOrders');

        // Inicialização do Mapa
        const map = L.map('map').setView([38.7223, -9.1393], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Cores dos status
        const statusColors = {
            aberta: '#28a745',
            pendente: '#ffc107',
            fechada: '#dc3545'
        };

        // Criar ícone do marcador
        function createMarkerIcon(status) {
            const color = statusColors[status] || statusColors.aberta;
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background:${color};width:24px;height:24px;border-radius:50%;border:2px solid white;"></div>`,
                iconSize: [24, 24]
            });
        }

        // Carregar WOs
        function loadWorkOrders() {
            const statusFilter = document.getElementById('filterStatus').value;
            
            onValue(woRef, (snapshot) => {
                // Limpar mapa e lista
                document.getElementById('woList').innerHTML = '';
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                if (!snapshot.exists()) {
                    document.getElementById('woList').innerHTML = '<p>Nenhuma WO encontrada</p>';
                    return;
                }

                snapshot.forEach((childSnapshot) => {
                    const wo = childSnapshot.val();
                    const woId = childSnapshot.key;

                    // Aplicar filtro
                    if (statusFilter && wo.status !== statusFilter) return;

                    // Criar marcador
                    const marker = L.marker([wo.lat, wo.lng], {
                        icon: createMarkerIcon(wo.status)
                    }).addTo(map).bindPopup(`
                        <b>${wo.woNumber}</b><br>
                        PDO: ${wo.pdo}<br>
                        Status: ${wo.status}
                    `);

                    // Adicionar à lista
                    const woItem = document.createElement('div');
                    woItem.className = 'wo-item';
                    woItem.innerHTML = `
                        <div><strong>${wo.woNumber}</strong> <span style="color:${statusColors[wo.status]}">(${wo.status})</span></div>
                        <div>PDO: ${wo.pdo}</div>
                        <div>${wo.lat}, ${wo.lng}</div>
                    `;
                    woItem.addEventListener('click', () => {
                        map.setView([wo.lat, wo.lng], 15);
                        marker.openPopup();
                    });
                    document.getElementById('woList').appendChild(woItem);
                });
            });
        }

        // Adicionar WO
        document.getElementById('woForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const woNumber = document.getElementById('woNumber').value.trim();
            const pdo = document.getElementById('pdo').value.trim();
            const coords = document.getElementById('coordinates').value.trim().split(',');
            
            if (!woNumber || !pdo || coords.length !== 2) return;
            
            const lat = parseFloat(coords[0]);
            const lng = parseFloat(coords[1]);
            
            if (isNaN(lat) || isNaN(lng)) return;

            push(woRef, {
                woNumber,
                pdo,
                lat,
                lng,
                status: 'aberta',
                createdAt: new Date().toISOString()
            }).then(() => {
                document.getElementById('woForm').reset();
                map.setView([lat, lng], 15);
            });
        });

        // Filtrar
        document.getElementById('filterForm').addEventListener('submit', (e) => {
            e.preventDefault();
            loadWorkOrders();
        });

        // Exportar
        document.getElementById('exportBtn').addEventListener('click', () => {
            // Implementação da exportação
        });

        // Inicializar
        loadWorkOrders();
    </script>
</body>
</html>
